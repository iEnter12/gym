<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>统计报表 - 体育场馆预约系统</title>
    <link rel="stylesheet" href="../../assets/css/common.css">
    <link rel="stylesheet" href="../../assets/css/admin.css">
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <script src="https://unpkg.com/vue@2/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/dayjs@1.11.10/dayjs.min.js"></script>
    <script src="https://unpkg.com/echarts@5.4.3/dist/echarts.min.js"></script>
</head>
<body>
    <div id="app">
        <!-- 侧边栏 -->
        <div class="admin-sidebar" :class="{ collapsed: sidebarCollapsed }">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="el-icon-trophy"></i>
                    <span v-if="!sidebarCollapsed">管理后台</span>
                </div>
                <el-button
                    type="text"
                    @click="sidebarCollapsed = !sidebarCollapsed"
                    class="collapse-btn">
                    <i :class="sidebarCollapsed ? 'el-icon-s-unfold' : 'el-icon-s-fold'"></i>
                </el-button>
            </div>
            
            <div class="sidebar-menu">
                <el-menu
                    :default-active="activeMenu"
                    :collapse="sidebarCollapsed"
                    background-color="#2c3e50"
                    text-color="#ecf0f1"
                    active-text-color="#3498db">
                    
                    <el-menu-item index="dashboard" @click="goToPage('dashboard')">
                        <i class="el-icon-data-analysis"></i>
                        <span slot="title">数据仪表盘</span>
                    </el-menu-item>
                    
                    <el-menu-item index="facilities" @click="goToPage('facilities')">
                        <i class="el-icon-office-building"></i>
                        <span slot="title">场馆管理</span>
                    </el-menu-item>
                    
                    <el-menu-item index="bookings" @click="goToPage('bookings')">
                        <i class="el-icon-tickets"></i>
                        <span slot="title">预约管理</span>
                    </el-menu-item>
                    
                    <el-menu-item index="reports" @click="goToPage('reports')">
                        <i class="el-icon-document"></i>
                        <span slot="title">统计报表</span>
                    </el-menu-item>
                    
                    <el-menu-item index="users" @click="goToPage('users')">
                        <i class="el-icon-user"></i>
                        <span slot="title">用户管理</span>
                    </el-menu-item>
                </el-menu>
            </div>
        </div>

        <!-- 主要内容区域 -->
        <div class="admin-main" :class="{ expanded: sidebarCollapsed }">
            <!-- 顶部导航 -->
            <div class="admin-header">
                <div class="header-left">
                    <h1>统计报表</h1>
                    <span class="page-desc">数据分析与报表生成</span>
                </div>
                
                <div class="header-right">
                    <el-dropdown @command="handleUserCommand">
                        <span class="user-dropdown">
                            <el-avatar :src="adminInfo.avatar" :size="32">
                                {{ adminInfo.real_name ? adminInfo.real_name.charAt(0) : 'A' }}
                            </el-avatar>
                            <span class="username">{{ adminInfo.real_name || adminInfo.username }}</span>
                            <i class="el-icon-arrow-down"></i>
                        </span>
                        <el-dropdown-menu slot="dropdown">
                            <el-dropdown-item command="profile">个人资料</el-dropdown-item>
                            <el-dropdown-item command="settings">系统设置</el-dropdown-item>
                            <el-dropdown-item divided command="logout">退出登录</el-dropdown-item>
                        </el-dropdown-menu>
                    </el-dropdown>
                </div>
            </div>

            <!-- 统计报表内容 -->
            <div class="dashboard-content">
                <!-- 报表筛选条件 -->
                <div class="report-filters">
                    <el-card shadow="never">
                        <div class="filter-row">
                            <div class="filter-item">
                                <label>时间范围：</label>
                                <el-date-picker
                                    v-model="dateRange"
                                    type="daterange"
                                    range-separator="至"
                                    start-placeholder="开始日期"
                                    end-placeholder="结束日期"
                                    style="width: 240px;"
                                    @change="handleDateChange">
                                </el-date-picker>
                            </div>
                            <div class="filter-item">
                                <label>场馆类型：</label>
                                <el-select
                                    v-model="facilityTypeFilter"
                                    placeholder="全部类型"
                                    style="width: 150px;"
                                    @change="handleFilterChange">
                                    <el-option label="全部类型" value=""></el-option>
                                    <el-option label="篮球场" value="篮球场"></el-option>
                                    <el-option label="羽毛球场" value="羽毛球场"></el-option>
                                    <el-option label="游泳池" value="游泳池"></el-option>
                                    <el-option label="乒乓球室" value="乒乓球室"></el-option>
                                </el-select>
                            </div>
                            <div class="filter-item">
                                <label>报表类型：</label>
                                <el-select
                                    v-model="reportType"
                                    placeholder="选择报表"
                                    style="width: 150px;"
                                    @change="handleReportTypeChange">
                                    <el-option label="综合报表" value="comprehensive"></el-option>
                                    <el-option label="收入报表" value="revenue"></el-option>
                                    <el-option label="使用率报表" value="usage"></el-option>
                                    <el-option label="用户报表" value="user"></el-option>
                                </el-select>
                            </div>
                            <div class="filter-actions">
                                <el-button type="primary" icon="el-icon-search" @click="generateReport">
                                    生成报表
                                </el-button>
                                <el-button type="success" icon="el-icon-download" @click="exportReport">
                                    导出报表
                                </el-button>
                            </div>
                        </div>
                    </el-card>
                </div>

                <!-- 关键指标概览 -->
                <div class="metrics-section">
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-icon" style="background: #3498db;">
                                <i class="el-icon-money"></i>
                            </div>
                            <div class="metric-info">
                                <div class="metric-value">¥{{ formatNumber(reportData.totalRevenue) }}</div>
                                <div class="metric-label">总收入</div>
                                <div class="metric-change positive">
                                    <i class="el-icon-arrow-up"></i>
                                    +15.3%
                                </div>
                            </div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-icon" style="background: #2ecc71;">
                                <i class="el-icon-tickets"></i>
                            </div>
                            <div class="metric-info">
                                <div class="metric-value">{{ formatNumber(reportData.totalBookings) }}</div>
                                <div class="metric-label">总预约数</div>
                                <div class="metric-change positive">
                                    <i class="el-icon-arrow-up"></i>
                                    +8.7%
                                </div>
                            </div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-icon" style="background: #f39c12;">
                                <i class="el-icon-user"></i>
                            </div>
                            <div class="metric-info">
                                <div class="metric-value">{{ formatNumber(reportData.activeUsers) }}</div>
                                <div class="metric-label">活跃用户</div>
                                <div class="metric-change positive">
                                    <i class="el-icon-arrow-up"></i>
                                    +12.1%
                                </div>
                            </div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-icon" style="background: #9b59b6;">
                                <i class="el-icon-pie-chart"></i>
                            </div>
                            <div class="metric-info">
                                <div class="metric-value">{{ reportData.avgUsageRate }}%</div>
                                <div class="metric-label">平均使用率</div>
                                <div class="metric-change positive">
                                    <i class="el-icon-arrow-up"></i>
                                    +3.2%
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 图表区域 -->
                <div class="charts-section">
                    <div class="charts-grid">
                        <!-- 收入趋势图 -->
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3>收入趋势分析</h3>
                                <el-button-group>
                                    <el-button 
                                        :type="revenueTimeRange === 'week' ? 'primary' : ''"
                                        size="mini"
                                        @click="changeRevenueTimeRange('week')">
                                        周
                                    </el-button>
                                    <el-button 
                                        :type="revenueTimeRange === 'month' ? 'primary' : ''"
                                        size="mini"
                                        @click="changeRevenueTimeRange('month')">
                                        月
                                    </el-button>
                                    <el-button 
                                        :type="revenueTimeRange === 'year' ? 'primary' : ''"
                                        size="mini"
                                        @click="changeRevenueTimeRange('year')">
                                        年
                                    </el-button>
                                </el-button-group>
                            </div>
                            <div id="revenueChart" class="chart-container"></div>
                        </div>

                        <!-- 场馆使用率分布 -->
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3>场馆使用率分布</h3>
                                <el-tooltip content="各类型场馆的使用率对比" placement="top">
                                    <i class="el-icon-info"></i>
                                </el-tooltip>
                            </div>
                            <div id="usageChart" class="chart-container"></div>
                        </div>

                        <!-- 预约时段分析 -->
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3>预约时段分析</h3>
                                <el-tooltip content="不同时段的预约热度分析" placement="top">
                                    <i class="el-icon-info"></i>
                                </el-tooltip>
                            </div>
                            <div id="timeSlotChart" class="chart-container"></div>
                        </div>

                        <!-- 用户活跃度分析 -->
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3>用户活跃度分析</h3>
                                <el-tooltip content="用户预约频次分布" placement="top">
                                    <i class="el-icon-info"></i>
                                </el-tooltip>
                            </div>
                            <div id="userActivityChart" class="chart-container"></div>
                        </div>
                    </div>
                </div>

                <!-- 数据表格 -->
                <div class="data-table-section">
                    <el-card shadow="never">
                        <div slot="header" class="table-header">
                            <h3>详细数据表</h3>
                            <div class="table-actions">
                                <el-button size="small" icon="el-icon-refresh" @click="refreshData">
                                    刷新数据
                                </el-button>
                                <el-button size="small" icon="el-icon-download" @click="exportTableData">
                                    导出表格
                                </el-button>
                            </div>
                        </div>

                        <el-table
                            :data="tableData"
                            style="width: 100%"
                            v-loading="tableLoading">
                            
                            <el-table-column prop="date" label="日期" width="120"></el-table-column>
                            <el-table-column prop="facility_type" label="场馆类型" width="120"></el-table-column>
                            <el-table-column prop="bookings" label="预约数" width="100"></el-table-column>
                            <el-table-column prop="revenue" label="收入(元)" width="120">
                                <template slot-scope="scope">
                                    ¥{{ formatNumber(scope.row.revenue) }}
                                </template>
                            </el-table-column>
                            <el-table-column prop="usage_rate" label="使用率" width="100">
                                <template slot-scope="scope">
                                    <el-progress 
                                        :percentage="scope.row.usage_rate" 
                                        :stroke-width="8"
                                        :show-text="false">
                                    </el-progress>
                                    <span style="margin-left: 10px;">{{ scope.row.usage_rate }}%</span>
                                </template>
                            </el-table-column>
                            <el-table-column prop="avg_duration" label="平均时长(小时)" width="140"></el-table-column>
                            <el-table-column prop="peak_hour" label="高峰时段" width="120"></el-table-column>
                            <el-table-column prop="user_count" label="用户数" width="100"></el-table-column>
                        </el-table>

                        <!-- 分页 -->
                        <div style="margin-top: 20px; text-align: right;">
                            <el-pagination
                                @size-change="handleSizeChange"
                                @current-change="handleCurrentChange"
                                :current-page="currentPage"
                                :page-sizes="[10, 20, 50, 100]"
                                :page-size="pageSize"
                                layout="total, sizes, prev, pager, next, jumper"
                                :total="totalData">
                            </el-pagination>
                        </div>
                    </el-card>
                </div>
            </div>
        </div>
    </div>

    <script src="../../utils/api.js"></script>
    <script src="../../utils/auth.js"></script>
    <script src="../../utils/mock.js"></script>
    <script>
        new Vue({
            el: '#app',
            data() {
                return {
                    adminInfo: {},
                    sidebarCollapsed: false,
                    activeMenu: 'reports',
                    dateRange: [],
                    facilityTypeFilter: '',
                    reportType: 'comprehensive',
                    revenueTimeRange: 'month',
                    tableLoading: false,
                    currentPage: 1,
                    pageSize: 10,
                    totalData: 0,
                    tableData: [],
                    reportData: {
                        totalRevenue: 1256780,
                        totalBookings: 8934,
                        activeUsers: 2156,
                        avgUsageRate: 73.5
                    },
                    charts: {
                        revenue: null,
                        usage: null,
                        timeSlot: null,
                        userActivity: null
                    }
                }
            },
            mounted() {
                this.checkAuth();
                this.loadAdminInfo();
                this.initDateRange();
                this.loadReportData();
                this.initCharts();
            },
            methods: {
                // 检查登录状态
                checkAuth() {
                    if (!Auth.requireAdmin()) {
                        return;
                    }
                },
                
                // 加载管理员信息
                loadAdminInfo() {
                    this.adminInfo = Auth.getUserInfo() || {};
                },
                
                // 初始化日期范围
                initDateRange() {
                    const end = new Date();
                    const start = new Date();
                    start.setTime(start.getTime() - 30 * 24 * 60 * 60 * 1000);
                    this.dateRange = [start, end];
                },
                
                // 加载报表数据
                loadReportData() {
                    this.tableLoading = true;
                    
                    // 模拟数据
                    setTimeout(() => {
                        this.tableData = this.generateTableData();
                        this.totalData = this.tableData.length;
                        this.tableLoading = false;
                    }, 500);
                },
                
                // 生成表格数据
                generateTableData() {
                    const data = [];
                    const types = ['篮球场', '羽毛球场', '游泳池', '乒乓球室'];
                    const peakHours = ['9:00-11:00', '14:00-16:00', '19:00-21:00'];
                    
                    for (let i = 0; i < 30; i++) {
                        const date = new Date();
                        date.setDate(date.getDate() - i);
                        
                        types.forEach(type => {
                            data.push({
                                date: dayjs(date).format('YYYY-MM-DD'),
                                facility_type: type,
                                bookings: 15 + Math.floor(Math.random() * 25),
                                revenue: 1200 + Math.floor(Math.random() * 2000),
                                usage_rate: 60 + Math.floor(Math.random() * 30),
                                avg_duration: (1.5 + Math.random() * 1.5).toFixed(1),
                                peak_hour: peakHours[Math.floor(Math.random() * peakHours.length)],
                                user_count: 8 + Math.floor(Math.random() * 15)
                            });
                        });
                    }
                    
                    return data.sort((a, b) => new Date(b.date) - new Date(a.date));
                },
                
                // 初始化图表
                initCharts() {
                    this.$nextTick(() => {
                        this.initRevenueChart();
                        this.initUsageChart();
                        this.initTimeSlotChart();
                        this.initUserActivityChart();
                    });
                },
                
                // 初始化收入趋势图
                initRevenueChart() {
                    const chart = echarts.init(document.getElementById('revenueChart'));
                    
                    const option = {
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: {
                                type: 'cross'
                            }
                        },
                        legend: {
                            data: ['收入', '预约数']
                        },
                        xAxis: {
                            type: 'category',
                            data: ['1月', '2月', '3月', '4月', '5月', '6月']
                        },
                        yAxis: [
                            {
                                type: 'value',
                                name: '收入(元)',
                                position: 'left'
                            },
                            {
                                type: 'value',
                                name: '预约数',
                                position: 'right'
                            }
                        ],
                        series: [
                            {
                                name: '收入',
                                type: 'line',
                                smooth: true,
                                data: [85000, 92000, 101000, 134000, 145000, 156000],
                                itemStyle: {
                                    color: '#3498db'
                                },
                                areaStyle: {
                                    color: {
                                        type: 'linear',
                                        x: 0,
                                        y: 0,
                                        x2: 0,
                                        y2: 1,
                                        colorStops: [{
                                            offset: 0, color: 'rgba(52, 152, 219, 0.3)'
                                        }, {
                                            offset: 1, color: 'rgba(52, 152, 219, 0.1)'
                                        }]
                                    }
                                }
                            },
                            {
                                name: '预约数',
                                type: 'bar',
                                yAxisIndex: 1,
                                data: [1200, 1350, 1480, 1680, 1820, 1950],
                                itemStyle: {
                                    color: '#2ecc71'
                                }
                            }
                        ]
                    };
                    
                    chart.setOption(option);
                    this.charts.revenue = chart;
                },
                
                // 初始化使用率分布图
                initUsageChart() {
                    const chart = echarts.init(document.getElementById('usageChart'));
                    
                    const option = {
                        tooltip: {
                            trigger: 'item',
                            formatter: '{a} <br/>{b}: {c}% ({d}%)'
                        },
                        legend: {
                            orient: 'vertical',
                            left: 'left'
                        },
                        series: [
                            {
                                name: '使用率',
                                type: 'pie',
                                radius: ['40%', '70%'],
                                avoidLabelOverlap: false,
                                label: {
                                    show: false,
                                    position: 'center'
                                },
                                emphasis: {
                                    label: {
                                        show: true,
                                        fontSize: '18',
                                        fontWeight: 'bold'
                                    }
                                },
                                labelLine: {
                                    show: false
                                },
                                data: [
                                    {value: 85, name: '篮球场', itemStyle: {color: '#3498db'}},
                                    {value: 78, name: '羽毛球场', itemStyle: {color: '#2ecc71'}},
                                    {value: 65, name: '游泳池', itemStyle: {color: '#f39c12'}},
                                    {value: 72, name: '乒乓球室', itemStyle: {color: '#9b59b6'}}
                                ]
                            }
                        ]
                    };
                    
                    chart.setOption(option);
                    this.charts.usage = chart;
                },
                
                // 初始化时段分析图
                initTimeSlotChart() {
                    const chart = echarts.init(document.getElementById('timeSlotChart'));
                    
                    const option = {
                        tooltip: {
                            trigger: 'axis'
                        },
                        xAxis: {
                            type: 'category',
                            data: ['8:00', '10:00', '12:00', '14:00', '16:00', '18:00', '20:00', '22:00']
                        },
                        yAxis: {
                            type: 'value',
                            name: '预约数'
                        },
                        series: [
                            {
                                name: '预约数',
                                type: 'bar',
                                data: [45, 78, 65, 89, 92, 156, 178, 134],
                                itemStyle: {
                                    color: {
                                        type: 'linear',
                                        x: 0,
                                        y: 0,
                                        x2: 0,
                                        y2: 1,
                                        colorStops: [{
                                            offset: 0, color: '#f39c12'
                                        }, {
                                            offset: 1, color: '#e67e22'
                                        }]
                                    }
                                }
                            }
                        ]
                    };
                    
                    chart.setOption(option);
                    this.charts.timeSlot = chart;
                },
                
                // 初始化用户活跃度图
                initUserActivityChart() {
                    const chart = echarts.init(document.getElementById('userActivityChart'));
                    
                    const option = {
                        tooltip: {
                            trigger: 'axis'
                        },
                        legend: {
                            data: ['新用户', '活跃用户', '回访用户']
                        },
                        xAxis: {
                            type: 'category',
                            data: ['周一', '周二', '周三', '周四', '周五', '周六', '周日']
                        },
                        yAxis: {
                            type: 'value'
                        },
                        series: [
                            {
                                name: '新用户',
                                type: 'line',
                                stack: 'Total',
                                data: [12, 15, 18, 22, 25, 35, 28],
                                itemStyle: {color: '#3498db'}
                            },
                            {
                                name: '活跃用户',
                                type: 'line',
                                stack: 'Total',
                                data: [45, 52, 48, 56, 62, 78, 65],
                                itemStyle: {color: '#2ecc71'}
                            },
                            {
                                name: '回访用户',
                                type: 'line',
                                stack: 'Total',
                                data: [23, 28, 25, 32, 35, 42, 38],
                                itemStyle: {color: '#f39c12'}
                            }
                        ]
                    };
                    
                    chart.setOption(option);
                    this.charts.userActivity = chart;
                },
                
                // 处理日期变化
                handleDateChange() {
                    this.loadReportData();
                },
                
                // 处理筛选变化
                handleFilterChange() {
                    this.loadReportData();
                },
                
                // 处理报表类型变化
                handleReportTypeChange() {
                    this.loadReportData();
                    this.updateCharts();
                },
                
                // 改变收入时间范围
                changeRevenueTimeRange(range) {
                    this.revenueTimeRange = range;
                    this.updateRevenueChart();
                },
                
                // 更新收入图表
                updateRevenueChart() {
                    if (!this.charts.revenue) return;
                    
                    let xData, revenueData, bookingData;
                    
                    if (this.revenueTimeRange === 'week') {
                        xData = ['周一', '周二', '周三', '周四', '周五', '周六', '周日'];
                        revenueData = [12000, 15000, 13000, 18000, 22000, 28000, 25000];
                        bookingData = [180, 220, 195, 260, 310, 380, 340];
                    } else if (this.revenueTimeRange === 'month') {
                        xData = ['1月', '2月', '3月', '4月', '5月', '6月'];
                        revenueData = [85000, 92000, 101000, 134000, 145000, 156000];
                        bookingData = [1200, 1350, 1480, 1680, 1820, 1950];
                    } else {
                        xData = ['2019', '2020', '2021', '2022', '2023', '2024'];
                        revenueData = [850000, 920000, 1010000, 1340000, 1450000, 1560000];
                        bookingData = [12000, 13500, 14800, 16800, 18200, 19500];
                    }
                    
                    this.charts.revenue.setOption({
                        xAxis: { data: xData },
                        series: [
                            { data: revenueData },
                            { data: bookingData }
                        ]
                    });
                },
                
                // 更新所有图表
                updateCharts() {
                    Object.values(this.charts).forEach(chart => {
                        if (chart) {
                            chart.resize();
                        }
                    });
                },
                
                // 生成报表
                generateReport() {
                    this.$message.success('报表生成成功');
                    this.loadReportData();
                },
                
                // 导出报表
                exportReport() {
                    this.$message.info('报表导出功能开发中');
                },
                
                // 刷新数据
                refreshData() {
                    this.loadReportData();
                    this.$message.success('数据已刷新');
                },
                
                // 导出表格数据
                exportTableData() {
                    this.$message.info('表格导出功能开发中');
                },
                
                // 分页大小改变
                handleSizeChange(val) {
                    this.pageSize = val;
                },
                
                // 当前页改变
                handleCurrentChange(val) {
                    this.currentPage = val;
                },
                
                // 格式化数字
                formatNumber(num) {
                    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                },
                
                // 页面跳转
                goToPage(page) {
                    this.activeMenu = page;
                    const pageMap = {
                        dashboard: 'dashboard.html',
                        facilities: 'facilities.html',
                        bookings: 'bookings.html',
                        reports: 'reports.html',
                        users: 'users.html'
                    };
                    if (pageMap[page] && page !== 'reports') {
                        window.location.href = pageMap[page];
                    }
                },
                
                // 处理用户下拉菜单命令
                handleUserCommand(command) {
                    switch (command) {
                        case 'profile':
                            this.$message.info('个人资料功能开发中');
                            break;
                        case 'settings':
                            this.$message.info('系统设置功能开发中');
                            break;
                        case 'logout':
                            this.handleLogout();
                            break;
                    }
                },
                
                // 处理退出登录
                handleLogout() {
                    this.$confirm('确定要退出登录吗？', '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        Auth.logout();
                        this.$message.success('已退出登录');
                        window.location.href = '../../index.html';
                    }).catch(() => {});
                }
            },
            beforeDestroy() {
                // 销毁图表实例
                Object.values(this.charts).forEach(chart => {
                    if (chart) {
                        chart.dispose();
                    }
                });
            }
        });
    </script>
</body>
</html>

